<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MBASCAPE — ESCAPE FROM ANALYTIX</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#10b981;--muted:#94a3b8;--panel:#0b1220;}
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  body{margin:0;background:linear-gradient(180deg,#071028 0%, #071a2a 60%);color:#e6eef6;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
  .app{width:1100px;max-width:100%;display:grid;grid-template-columns:1fr 360px;gap:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  h1{margin:0;font-size:20px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:14px;border-radius:12px}
  .map{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .region{background:#071b24;border-radius:10px;padding:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .region h3{margin:0 0 6px 0;font-size:14px}
  .region small{color:var(--muted)}
  .status{font-weight:600;font-size:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#041018;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  .right{display:flex;flex-direction:column;gap:12px}
  .inv-grid{display:flex;flex-wrap:wrap;gap:8px}
  .tile{width:48px;height:48px;border-radius:8px;background:#142a32;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;cursor:grab;border:1px solid rgba(255,255,255,0.03)}
  .tray{display:grid;grid-template-columns:repeat(8,38px);gap:6px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;min-height:56px;align-items:center}
  .slot{height:38px;border-radius:6px;border:2px dashed rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:800;color:#cfe7df;background:transparent}
  .slot.filled{border-style:solid;background:#0e2830}
  .modal-backdrop{position:fixed;inset:0;background:rgba(1,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{width:780px;max-width:96%;background:linear-gradient(180deg,#081621,#071018);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04)}
  input[type="text"]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;width:100%}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .message{padding:8px;border-radius:8px;background:rgba(16,185,129,0.06);color:var(--accent);border:1px solid rgba(16,185,129,0.12);font-weight:700}
  footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  .player-pill{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:#08171d;color:#bfead9;font-weight:700;font-size:13px}
  .player-section{display:flex;flex-direction:column;gap:8px}
  .region-meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .search-btn{padding:8px 10px;border-radius:8px;border:none;background:#0b5b4a;color:#dff5ea;cursor:pointer;font-weight:700}
  .disabled{opacity:0.45;cursor:not-allowed}
  .timer{font-weight:900;font-family:monospace;background:#071a1a;padding:6px 10px;border-radius:8px}
  @media (max-width:1080px){.app{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>MBASCAPE — ESCAPE FROM ANALYTIX</h1>
        <div class="small">Team-based campus escape — collect clues, form the phrase, unlock the WAY OUT LOCK</div>
      </div>
      <div class="controls">
        <div class="timer" id="timer">30:00</div>
        <button class="btn" id="startBtn">Start Game</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>
    </header>

    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong>Campus Map — Click a region to open puzzle</strong><div class="small">Solve puzzle → search region → collect clue</div></div>
        <div class="small">Players: <span id="playerCount">0</span>/5</div>
      </div>

      <div style="margin-bottom:12px" id="teamEntry">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input placeholder="Player 1 name" id="p1" type="text" />
          <input placeholder="Player 2 name" id="p2" type="text" />
          <input placeholder="Player 3 name" id="p3" type="text" />
          <input placeholder="Player 4 name" id="p4" type="text" />
          <input placeholder="Player 5 name" id="p5" type="text" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="createTeam">Create Team</button>
          <button class="btn secondary" id="autoFill">Autofill Names</button>
        </div>
      </div>

      <div class="map" id="map">
        </div>

      <div style="margin-top:12px" class="hint small">
        Tip: Communicate — assign players to regions, collect letters, drag them into the tray and arrange in order. Target phrase: <strong>I ESCAPED YAY</strong>
      </div>
    </section>

    <aside class="panel right">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Clue Inventory</strong><div class="small">Drag tiles into the final tray</div></div>
          <div><strong>Final Target</strong><div class="small">I ESCAPED YAY</div></div>
        </div>
        <div style="margin-top:10px" id="playerPills" class="player-section"></div>
      </div>

      <div>
        <div class="small" style="margin-bottom:8px">Collected Clue Tiles</div>
        <div id="inventory" class="inv-grid"></div>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="small" id="trayLabel">Final Lock Tray</div>
          <div style="display:flex;gap:8px">
            <button class="btn secondary" id="undoBtn">Undo</button>
            <button class="btn secondary" id="shuffleBtn">Shuffle</button>
            <button class="btn" id="unlockBtn">UNLOCK</button>
          </div>
        </div>
        <div id="tray" class="tray" ondragover="event.preventDefault()"></div>
      </div>

      <div id="log" style="margin-top:8px"></div>
    </aside>

    <footer class="panel" style="text-align:center">
      <div class="small">Built for quick campus events — open the HTML file to play. Have fun & good luck!</div>
    </footer>
  </div>

<div id="modalBackdrop" style="display:none" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div>
        <h2 id="modalTitle">Region</h2>
        <div class="small" id="modalSub">Puzzle</div>
      </div>
      <div style="display:flex;gap:8px">
        <div class="small">Player:</div>
        <select id="collectorSelect"></select>
        <button class="btn secondary" id="closeModal">Close</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div id="puzzlePrompt" style="font-weight:700;margin-bottom:8px"></div>
      <div class="small" id="puzzleHint"></div>
      <div style="margin-top:10px" class="row">
        <input id="puzzleAnswer" type="text" placeholder="Type your answer (press Enter or Submit)" />
        <button class="btn" id="submitAnswer">Submit</button>
        <button class="search-btn disabled" id="searchRegion" disabled>Search Region</button>
      </div>
      <div id="puzzleMsg" style="margin-top:10px"></div>

      <div style="margin-top:12px" class="region-meta">
        <div class="small">Status: <span id="regionStatus">Locked</span></div>
        <div class="small">Searched: <span id="regionSearched">No</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  MBASCAPE — Single HTML implementation
  - Team of up to 5 players
  - Regions, Puzzles, and Clues are randomized for replayability.
*/

const TARGET_PHRASE = "I ESCAPED YAY";
const TARGET = TARGET_PHRASE.replace(/\s+/g, "");
const TRAY_SLOTS = TARGET.length;
const GAME_SECONDS = 30 * 60; // 30 minutes default

// --- Data Definitions ---

// A pool of all available puzzles. These will be randomly assigned to regions.
const PUZZLES = [
  {prompt:"Decode Caesar (shift 3): KHOOR", answer:"HELLO"},
  {prompt:"If 2▲=4, 3▲=27, 4▲=?", answer:"256"},
  {prompt:"Riddle: I speak without a mouth and hear without ears. What am I?", answer:"ECHO"},
  {prompt:"Unscramble: AEMLS", answer:"MEALS"},
  {prompt:"Sequence: 1,1,2,3,5,8,13, ?", answer:"21"},
  {prompt:"Anagram: PACESE (single word)", answer:"ESCAPE"},
  {prompt:"Python code: print(256 % 8)", answer:"0"},
  {prompt:"Math: (144 / 12) + 5", answer:"17"},
  {prompt:"Synonym for 'quit' (5 letters)", answer:"LEAVE"},
  {prompt:"Roman numerals: X + V + I", answer:"16"},
  {prompt:"Unscramble: LANAYTIX", answer:"ANALYTIX"},
  {prompt:"What is 12 * 12?", answer:"144"},
  {prompt:"Reverse this: XITYLANA", answer:"ANALYTIX"},
  {prompt:"Riddle: The more you take from me, the bigger I get. What am I?", answer:"HOLE"},
  {prompt:"I HIDE IN DARK, BUT SHINE WHEN ITS BRIGHT, WHAT AM I?", answer:"BULB"},
  {prompt:"Square root of 256?", answer:"16"},
  {prompt:"First 3 letters of 'ANALYTIX'?", answer:"ANA"},
  {prompt:"Last letter of the alphabet?", answer:"Z"},
];

// Region definitions. Puzzles and clues will be assigned dynamically.
// `clue: 'X'` is a placeholder to mark this region as one that can hold a clue letter.
const REGIONS = [
  {id:"library", name:"Library", clue:"X"},
  {id:"academic", name:"Academic Block", clue:"X"},
  {id:"hostel", name:"Hostel", clue:"X"},
  {id:"mess", name:"Mess & Cafeteria", clue:"X"},
  {id:"sports", name:"Sports Ground", clue:"X"},
  {id:"amphi", name:"Amphitheatre", clue:"X"},
  {id:"lab", name:"Analytics Lab"},
  {id:"ground", name:"Open Ground", clue:"X"},
  {id:"seminar", name:"Seminar Hall", clue:"X"},
  {id:"library2", name:"Library 2nd Floor"},
  {id:"dorm", name:"Dormitory", clue:"X"},
  {id:"classroom", name:"Classroom"},
  {id:"parking", name:"Parking Lot", clue:"X"},
  {id:"canteen", name:"Canteen"},
  {id:"auditorium", name:"Auditorium"},
  {id:"garden", name:"Campus Garden"},
  {id:"lab2", name:"Data Lab", clue:"X"},
  {id:"library3", name:"Library Basement"},
];


// --- Randomization Logic ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function randomizeClues() {
  const clueLetters = TARGET.split('');
  shuffleArray(clueLetters);
  const clueRegions = REGIONS.filter(r => r.hasOwnProperty('clue'));
  if (clueRegions.length < clueLetters.length) {
    console.error("Warning: Not enough regions with 'clue' properties for all the letters.");
  }
  clueRegions.forEach((region, index) => {
    if (index < clueLetters.length) {
      region.clue = clueLetters[index];
    } else {
      delete region.clue; 
    }
  });
}

function randomizePuzzles() {
  shuffleArray(PUZZLES);
  if (REGIONS.length > PUZZLES.length) {
    console.error("Warning: Not enough puzzles for all regions.");
  }
  REGIONS.forEach((region, index) => {
    if (PUZZLES[index]) {
      region.prompt = PUZZLES[index].prompt;
      region.answer = PUZZLES[index].answer;
    }
  });
}

function setupNewGame() {
  randomizePuzzles();
  randomizeClues();
}
setupNewGame(); // Initial setup on script load

// --- Game State & DOM Refs ---
let players = [];
let playerCount = 0;
let regionState = {};
let clues = [];
let tray = Array(TRAY_SLOTS).fill(null);
let undoStack = [];
let timerInterval = null;
let secondsLeft = GAME_SECONDS;
let gameStarted = false;

const mapEl = document.getElementById('map');
const inventoryEl = document.getElementById('inventory');
const trayEl = document.getElementById('tray');
const logEl = document.getElementById('log');
const timerEl = document.getElementById('timer');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const createTeamBtn = document.getElementById('createTeam');
const autoFillBtn = document.getElementById('autoFill');
const playerPills = document.getElementById('playerPills');
const playerCountEl = document.getElementById('playerCount');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalSub = document.getElementById('modalSub');
const puzzlePrompt = document.getElementById('puzzlePrompt');
const puzzleHint = document.getElementById('puzzleHint');
const puzzleAnswer = document.getElementById('puzzleAnswer');
const submitAnswerBtn = document.getElementById('submitAnswer');
const puzzleMsg = document.getElementById('puzzleMsg');
const regionStatus = document.getElementById('regionStatus');
const regionSearched = document.getElementById('regionSearched');
const searchRegionBtn = document.getElementById('searchRegion');
const closeModalBtn = document.getElementById('closeModal');
const collectorSelect = document.getElementById('collectorSelect');
const unlockBtn = document.getElementById('unlockBtn');
const undoBtn = document.getElementById('undoBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const startInputArea = document.getElementById('teamEntry');
const trayLabel = document.getElementById('trayLabel');

// --- Core Game Functions ---
function init() {
  mapEl.innerHTML = '';
  for (const r of REGIONS) {
    const el = document.createElement('div');
    el.className = 'region';
    el.id = 'reg-' + r.id;
    el.innerHTML = `<h3>${r.name}</h3><div class="small">${r.id}</div>
      <div style="margin-top:8px" class="region-meta">
        <div class="status" id="status-${r.id}">🔒 Locked</div>
        <div class="small" id="searched-${r.id}">Unsearched</div>
      </div>`;
    el.addEventListener('click', () => openRegion(r.id));
    mapEl.appendChild(el);
    regionState[r.id] = { solved:false, searched:false, collector:null };
  }
  trayLabel.textContent = `Final Lock Tray (${TRAY_SLOTS} letters)`;
  trayEl.style.gridTemplateColumns = `repeat(${TRAY_SLOTS}, 1fr)`;
  renderTray();
  renderInventory();
  updateTimerDisplay();
  updatePlayerCount();
  attachEventHandlers();
}

function attachEventHandlers(){
  createTeamBtn.addEventListener('click', createTeam);
  autoFillBtn.addEventListener('click', autofillNames);
  startBtn.addEventListener('click', startGame);
  resetBtn.addEventListener('click', resetGame);
  closeModalBtn.addEventListener('click', closeModal);
  submitAnswerBtn.addEventListener('click', submitPuzzleAnswer);
  searchRegionBtn.addEventListener('click', handleSearchFromModal);
  puzzleAnswer.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitPuzzleAnswer(); });
  unlockBtn.addEventListener('click', tryUnlock);
  undoBtn.addEventListener('click', undoLast);
  shuffleBtn.addEventListener('click', shuffleTrayLetters);
}

function createTeam(){
  players = [];
  for (let i=1;i<=5;i++){
    const val = (document.getElementById('p'+i).value||'').trim();
    if(val) players.push({id:'p'+i, name: val});
  }
  if(players.length===0){
    alert('Enter at least one player name to form a team (you can add up to 5).');
    return;
  }
  playerCount = players.length;
  populatePlayerPills();
  populateCollectorSelect();
  startInputArea.style.display = 'none';
  updatePlayerCount();
}

function autofillNames(){
  document.getElementById('p1').value='Player A';
  document.getElementById('p2').value='Player B';
  document.getElementById('p3').value='Player C';
}

function populatePlayerPills(){
  playerPills.innerHTML = '';
  for(const p of players){
    const el = document.createElement('div');
    el.className='player-pill';
    el.textContent = p.name;
    playerPills.appendChild(el);
  }
}

function populateCollectorSelect(){
  collectorSelect.innerHTML = '';
  for(const p of players){
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name;
    collectorSelect.appendChild(opt);
  }
}

function updatePlayerCount(){
  playerCountEl.textContent = String(players.length);
}

function startGame(){
  if(players.length===0){
    alert('Create or autofill a team first (at least one player).');
    return;
  }
  if(gameStarted) return;
  gameStarted = true;
  startBtn.disabled = true;
  startBtn.textContent = 'Game Running';
  secondsLeft = GAME_SECONDS;
  timerInterval = setInterval(()=>{
    secondsLeft--;
    updateTimerDisplay();
    if(secondsLeft<=0){
      clearInterval(timerInterval);
      endGame(false);
    }
  },1000);
  log('Game started. Good luck!');
}

function updateTimerDisplay(){
  const m = Math.floor(secondsLeft/60).toString().padStart(2,'0');
  const s = (secondsLeft%60).toString().padStart(2,'0');
  timerEl.textContent = `${m}:${s}`;
  if(secondsLeft<=60) timerEl.style.color='#ff8a65'; else timerEl.style.color='';
}

function resetGame(){
  if(timerInterval) clearInterval(timerInterval);
  secondsLeft = GAME_SECONDS;
  gameStarted = false;
  startBtn.disabled = false;
  startBtn.textContent = 'Start Game';
  clues = [];
  tray = Array(TRAY_SLOTS).fill(null);
  undoStack = [];
  setupNewGame();
  for(const r of REGIONS) regionState[r.id] = {solved:false,searched:false,collector:null};
  startInputArea.style.display = '';
  players = [];
  playerCount = 0;
  playerPills.innerHTML = '';
  populateCollectorSelect();
  renderInventory();
  renderTray();
  refreshRegionUI();
  log('Game reset for a new round with new puzzles.');
  updatePlayerCount();
  updateTimerDisplay();
}

function refreshRegionUI(){
  for(const r of REGIONS){
    const sEl = document.getElementById('status-'+r.id);
    const seEl = document.getElementById('searched-'+r.id);
    if(regionState[r.id].solved) sEl.textContent = '✅ Escaped';
    else sEl.textContent = '🔒 Locked';
    seEl.textContent = regionState[r.id].searched ? 'Yes' : 'No';
  }
}

function openRegion(regionId){
  const region = REGIONS.find(r=>r.id===regionId);
  if(!region) return;
  modalTitle.textContent = region.name;
  modalSub.textContent = region.id;
  puzzlePrompt.textContent = region.prompt;
  puzzleAnswer.value = '';
  puzzleMsg.innerHTML = '';
  regionStatus.textContent = regionState[regionId].solved ? '✅ Escaped' : '🔒 Locked';
  regionSearched.textContent = regionState[regionId].searched ? 'Yes' : 'No';
  searchRegionBtn.disabled = !regionState[regionId].solved;
  searchRegionBtn.classList.toggle('disabled',!regionState[regionId].solved);
  modalBackdrop.style.display = 'flex';
  modalBackdrop.dataset.region = regionId;
}

function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.dataset.region=''; }

function submitPuzzleAnswer(){
  const regionId = modalBackdrop.dataset.region;
  if(!regionId) return;
  const region = REGIONS.find(r=>r.id===regionId);
  const ans = (puzzleAnswer.value||'').trim().toUpperCase();
  if(!ans){ puzzleMsg.innerHTML = '<div class="small">Type an answer first.</div>'; return; }
  const correct = region.answer.toString().trim().toUpperCase();
  if(ans === correct){
    regionState[regionId].solved = true;
    regionState[regionId].collector = null;
    puzzleMsg.innerHTML = '<div class="message">Correct! Region escaped — now SEARCH to find the clue tile.</div>';
    regionStatus.textContent = '✅ Escaped';
    searchRegionBtn.disabled = false;
    searchRegionBtn.classList.remove('disabled');
    refreshRegionUI();
    log(`Region ${region.name} solved.`);
  } else {
    puzzleMsg.innerHTML = '<div class="small" style="color:#ff9aa2">Incorrect answer — try again.</div>';
  }
}

function handleSearchFromModal(){
  const regionId = modalBackdrop.dataset.region;
  if(!regionId) return;
  handleSearch(regionId);
}

function handleSearch(regionId){
  const region = REGIONS.find(r=>r.id===regionId);
  if(!region) return;

  if(!regionState[regionId].solved){ 
    puzzleMsg.innerHTML = '<div class="small" style="color:#ff9aa2">You must solve the puzzle before you can search the region.</div>';
    return;
  }
  if(regionState[regionId].searched){ 
    puzzleMsg.innerHTML = '<div class="small">This region has already been searched.</div>';
    return;
  }

  regionState[regionId].searched = true;
  regionSearched.textContent = 'Yes';
  refreshRegionUI();
  
  const collectorId = collectorSelect.value || (players[0]&&players[0].id);
  const collectorName = getPlayerNameById(collectorId);

  if(region.clue===undefined){ 
    puzzleMsg.innerHTML = `<div class="small" style="font-weight:700">Searched by ${collectorName}. SORRY NO CLUE FOUND. TRY SOME OTHER PLACE.</div>`;
    log(`${collectorName} searched ${region.name} but found no clue.`);
    return;
  }
  
  regionState[regionId].collector = collectorId;
  const tile = {
    id: 'tile-' + Math.random().toString(36).slice(2,8),
    letter: region.clue,
    from: region.name,
    collectedBy: collectorId
  };
  clues.push(tile);
  renderInventory();
  puzzleMsg.innerHTML = `<div class="message">You found a clue: '${tile.letter}' — collected by ${collectorName}.</div>`;
  log(`${collectorName} found '${tile.letter}' at ${region.name}.`);
}

function getPlayerNameById(id){
  const p = players.find(x=>x.id===id);
  return p ? p.name : id;
}

function renderInventory(){
  inventoryEl.innerHTML = '';
  for(const t of clues){
    const el = document.createElement('div');
    el.className = 'tile';
    el.draggable = true;
    el.id = t.id;
    el.title = `${t.letter} — from ${t.from} (by ${getPlayerNameById(t.collectedBy)})`;
    el.textContent = t.letter;
    el.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', t.id);
    });
    inventoryEl.appendChild(el);
  }
}

function renderTray(){
  trayEl.innerHTML = '';
  for(let i=0;i<TRAY_SLOTS;i++){
    const slot = document.createElement('div');
    slot.className = 'slot' + (tray[i] ? ' filled' : '');
    slot.dataset.idx = i;
    slot.textContent = tray[i] || '';
    slot.addEventListener('dragover', (e)=> e.preventDefault());
    slot.addEventListener('drop', (e)=>{
      e.preventDefault();
      const tileId = e.dataTransfer.getData('text/plain');
      placeTileIntoSlot(tileId, parseInt(slot.dataset.idx,10));
    });
    trayEl.appendChild(slot);
  }
}

function placeTileIntoSlot(tileId, slotIndex){
  const tileIndex = clues.findIndex(c=>c.id===tileId);
  if(tileIndex===-1) return;
  if(tray[slotIndex]){
    const nextEmpty = tray.indexOf(null);
    if(nextEmpty === -1){ alert('Tray full. Undo or remove a letter first.'); return; }
    slotIndex = nextEmpty;
  }
  const tile = clues.splice(tileIndex,1)[0];
  tray[slotIndex] = tile.letter;
  undoStack.push({action:'placed', tile, slot:slotIndex});
  renderInventory();
  renderTray();
  log(`Placed '${tile.letter}' into tray slot ${slotIndex+1}.`);
}

function undoLast(){
  if(undoStack.length===0) return;
  const last = undoStack.pop();
  if(last.action === 'placed' && last.tile){
    tray[last.slot] = null;
    clues.push(last.tile);
    renderInventory();
    renderTray();
    log(`Undo: returned '${last.tile.letter}' to inventory.`);
  }
}

function shuffleTrayLetters(){
  const letters = tray.filter(Boolean);
  shuffleArray(letters);
  tray = Array(TRAY_SLOTS).fill(null);
  for(let i=0;i<letters.length;i++) tray[i] = letters[i];
  undoStack.push({action:'shuffled'});
  renderTray();
  log('Shuffled tray letters.');
}

function tryUnlock(){
  const attempt = tray.join('');
  if(attempt === TARGET){
    endGame(true);
  } else {
    alert(`Lock refused. Current tray spells: "${attempt || '(empty)'}". Keep arranging.`);
    log(`Unlock attempt failed: "${attempt}"`);
  }
}

function endGame(won){
  if(timerInterval) clearInterval(timerInterval);
  gameStarted = false;
  startBtn.disabled = true; 
  if(won){
    alert(`🎉 WAY OUT LOCK opened! You escaped: ${TARGET_PHRASE}`);
    log('Team escaped — WIN!');
  } else {
    alert("⏰ Time's up. The team failed to escape.");
    log('Time up — team lost.');
  }
}

function log(msg){
  const t = new Date().toLocaleTimeString();
  const el = document.createElement('div');
  el.className = 'small';
  el.textContent = `[${t}] ${msg}`;
  logEl.prepend(el);
}

trayEl.addEventListener('drop', (e)=>{
  e.preventDefault();
  const tileId = e.dataTransfer.getData('text/plain');
  const firstEmpty = tray.indexOf(null);
  if(firstEmpty === -1){ alert('Tray full. Undo first.'); return; }
  placeTileIntoSlot(tileId, firstEmpty);
});
trayEl.addEventListener('dragover', e=>e.preventDefault());

init();

</script>
</body>
</html>
